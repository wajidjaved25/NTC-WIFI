# RADIUS Integration - Final Update

## What Changed

### Frontend Update (Public Portal)
**File: `NTC/public-portal/src/components/SuccessPage.jsx`**

**REMOVED:**
- API call to `/authorize` endpoint
- Omada API authorization attempt
- Error handling for authorization failures

**ADDED:**
- Clear instructions showing user their login credentials
- Automatic redirect to Omada captive portal login page
- 5-second countdown before redirect
- Manual "Continue" button option
- Displays username (mobile) and password (CNIC/passport) for easy reference

### Backend (Already Updated)
- `/register` creates RADIUS user automatically ✓
- `/authorize` only logs session for tracking ✓
- RADIUS service handles user management ✓

## Complete Flow Now

### 1. User Registration (Your Portal)
```
User → Ads → Registration Form → OTP Verification → RADIUS User Created
```

### 2. WiFi Authentication (Omada + RADIUS)
```
User → Success Page (shows credentials) → 
Redirects to Omada Login → 
User enters mobile + CNIC → 
Omada → RADIUS Server → 
RADIUS validates → 
Internet Access Granted
```

## User Experience

1. **Connect to WiFi SSID**
   - User connects to "NTC Public WiFi"
   - Omada captive portal opens

2. **View Ads & Register**
   - Portal shows advertisements
   - User fills registration form
   - Verifies with OTP
   - RADIUS account created automatically

3. **Success Page**
   - Shows registration success
   - Displays login credentials clearly:
     - Username: 03001234567
     - Password: 12345-1234567-1
   - 5-second countdown
   - Redirects to Omada login

4. **Omada Login**
   - User enters credentials
   - Omada sends RADIUS request
   - FreeRADIUS validates
   - User gets internet for 1 hour

## Testing Steps

### 1. Test Complete Flow
```bash
# Start backend
cd /opt/ntc-wifi/backend
python3 -m uvicorn app.main:app --host 0.0.0.0 --port 8000

# Monitor RADIUS
sudo freeradius -X
```

### 2. Connect to WiFi
- Connect to SSID
- Portal should open automatically
- Go through registration
- Note the credentials shown
- You'll be redirected to Omada login
- Enter mobile + CNIC
- Should get internet access

### 3. Verify RADIUS
```bash
# Check RADIUS user was created
sudo -u postgres psql -d ntc_wifi_admin
SELECT * FROM radcheck WHERE username = '03001234567';

# Check authentication logs
SELECT * FROM radpostauth ORDER BY authdate DESC LIMIT 5;

# Check active sessions
SELECT * FROM radacct WHERE acctstoptime IS NULL;
```

## Important Notes

⚠️ **Redirect URL**: Default is `http://192.168.3.1:8843/` - update in SuccessPage.jsx if your Omada controller has different IP

⚠️ **User Credentials**:
- Username = Mobile number
- Password = CNIC or Passport number

⚠️ **Session Timeout**: Default 3600 seconds (1 hour) - configured in RADIUS

✅ **No More Omada API Calls**: Authentication happens purely through RADIUS now

## Deployment

### 1. Update Frontend
```bash
cd /opt/ntc-wifi/public-portal
npm run build
sudo systemctl restart apache2
```

### 2. Verify Services
```bash
# Backend
sudo systemctl status ntc-wifi-backend

# RADIUS
sudo systemctl status freeradius

# Apache
sudo systemctl status apache2
```

### 3. Test End-to-End
- Connect to WiFi from mobile device
- Complete full registration flow
- Authenticate on Omada login page
- Verify internet access works

## Troubleshooting

**Issue: Redirect not working**
- Check Omada controller IP in SuccessPage.jsx
- Verify Omada captive portal is enabled

**Issue: RADIUS authentication fails**
- Check FreeRADIUS is running: `sudo systemctl status freeradius`
- Check RADIUS logs: `sudo freeradius -X`
- Verify user exists: `SELECT * FROM radcheck WHERE username = 'mobile';`

**Issue: User created but can't login**
- Verify password in radcheck matches CNIC/passport
- Check Omada RADIUS configuration (IP, port, secret)
- Test manually: `radtest mobile password 127.0.0.1 0 testing123`

## Success Indicators

✓ RADIUS user created during registration
✓ Success page shows credentials clearly
✓ User redirected to Omada login page
✓ User can enter credentials on Omada portal
✓ RADIUS server receives authentication request
✓ User gets internet access for 1 hour
✓ Session tracked in radacct table
